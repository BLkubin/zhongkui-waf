server {
    listen       1226;
    server_name  localhost;

    charset utf-8;

    #access_log  logs/zhongkui.access.log  main;

    # path-to-zhongkui-waf/admin
    set $root_path /usr/local/openresty/zhongkui-waf/admin;

    location /sites/ {
        content_by_lua_file $root_path/lua/website.lua;
        proxy_set_header  X-Real-IP  $remote_addr;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /defense/ {
        content_by_lua_file $root_path/lua/defense.lua;
    }

    location /other/ {
        content_by_lua_file $root_path/lua/other.lua;
    }

    location /dashboard {
        content_by_lua_file $root_path/lua/dashboard.lua;
    }

    location /user/ {
        content_by_lua_block {
            local user = require "user"
            user.doRequest()
        }
    }

    location ~* \.(html)$ {
        access_by_lua_block {
            local user = require "user"
            if user.checkAuthToken() == false then
                ngx.redirect("/login")
            end
        }

        root   $root_path;
        proxy_set_header  Host  $host; 
        proxy_set_header  X-Real-IP  $remote_addr; 
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /login {
        default_type 'text/html';
        alias $root_path/login.html;
        proxy_set_header  Host  $host; 
        proxy_set_header  X-Real-IP  $remote_addr; 
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location = /admin/data/user.json {
        deny all;
        return 403;
    }

    location ^~ /admin/lua/ {
        deny all;
        return 403;
    }
    
    location / {
        root   $root_path;
        proxy_set_header  Host  $host; 
        proxy_set_header  X-Real-IP  $remote_addr; 
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    }

}